<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shop Heater Web UI</title>

<style>
  body {
    margin: 0;
    background: #111;
    color: #ddd;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    padding: 20px;
  }

  .container {
    width: 100%;
    max-width: 900px;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    width: 100%;
    margin-bottom: 30px;
  }

  .cell {
    aspect-ratio: 1 / 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  img {
    width: 64%;
    height: auto;
    display: block;
    transform-origin: center center;
  }

  .label {
    font-size: 12px;
    color: #aaa;
    text-align: center;
  }

  .value {
    font-size: 14px;
    font-weight: bold;
    color: #fff;
    text-align: center;
  }

  .temp-value {
    font-size: 56px;
    font-weight: bold;
    line-height: 1.2;
    /* Color will be set dynamically based on temperature */
  }

  .delta-value {
    font-size: 56px;
    font-weight: bold;
    line-height: 1.2;
    color: #44ff88;
  }

  .flow-value {
    font-size: 56px;
    font-weight: bold;
    line-height: 1.2;
    color: #4CAF50;
  }

  .flow-value {
    color: #4488ff;
  }

  .overlay-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 16px;
    font-weight: bold;
    color: #fff;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    z-index: 10;
  }

  .controls {
    background: #222;
    padding: 20px;
    border-radius: 8px;
    width: 100%;
  }

  .control-group {
    margin-bottom: 20px;
  }

  .control-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #fff;
  }

  .toggle-container {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .toggle {
    position: relative;
    width: 60px;
    height: 30px;
  }

  .toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #555;
    transition: .4s;
    border-radius: 30px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: #4CAF50;
  }

  input:checked + .slider:before {
    transform: translateX(30px);
  }

  .toggle-label {
    font-size: 14px;
    color: #aaa;
  }

  .fan-controls {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  .fan-controls input[type="number"] {
    width: 80px;
    padding: 8px;
    font-size: 16px;
    background: #333;
    color: #fff;
    border: 1px solid #555;
    border-radius: 4px;
  }

  .fan-controls input[type="range"] {
    flex: 1;
    height: 8px;
    background: #555;
    border-radius: 5px;
    outline: none;
  }

  .fan-controls input[type="range"]::-webkit-slider-thumb {
    width: 20px;
    height: 20px;
    background: #4CAF50;
    cursor: pointer;
    border-radius: 50%;
  }

  .status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-left: 10px;
  }

  .status-connected {
    background: #4CAF50;
  }

  .status-disconnected {
    background: #f44336;
  }

  h2 {
    color: #fff;
    margin-top: 0;
    display: flex;
    align-items: center;
  }

  .mode-selector {
    background: #333;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 2px solid #555;
  }

  .mode-selector.manual {
    border-color: #4CAF50;
    background: #1a3a1a;
  }

  .mode-selector.automatic {
    border-color: #FFA500;
    background: #3a2a1a;
  }

  .mode-label {
    font-size: 16px;
    font-weight: bold;
    color: #fff;
  }

  .mode-badge {
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 14px;
  }

  .mode-badge.manual {
    background: #4CAF50;
    color: #fff;
  }

  .mode-badge.automatic {
    background: #FFA500;
    color: #000;
  }

  .controls.disabled {
    opacity: 0.6;
    pointer-events: none;
  }

  .automation-notice {
    background: #3a2a1a;
    border: 1px solid #FFA500;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
    color: #FFA500;
    text-align: center;
    font-size: 14px;
    display: none;
  }

  .automation-notice.visible {
    display: block;
  }

  /* Disabled control styling for automatic mode */
  .toggle input:disabled + .slider {
    background-color: #444;
    cursor: not-allowed;
    opacity: 0.5;
  }

  .toggle input:disabled:checked + .slider {
    background-color: #666;
  }

  input[type="number"]:disabled,
  input[type="range"]:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  input[type="range"]:disabled::-webkit-slider-thumb {
    background: #666;
    cursor: not-allowed;
  }

  /* Navigation links */
  .nav-links {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .nav-links a {
    color: #fff;
    text-decoration: none;
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    transition: background 0.3s;
    font-size: 14px;
  }

  .nav-links a:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .nav-links a.active {
    background: #4CAF50;
    font-weight: bold;
  }
</style>
</head>

<body>

<div class="container">

<h2>ðŸ“Š Shop Heater Dashboard <span class="status-indicator" id="wsStatus"></span></h2>

<div class="nav-links">
  <a href="/" class="active">Dashboard</a>
  <a href="/controls">Controls</a>
  <a href="/graph">Live Graph</a>
  <a href="/explorer">Data Explorer</a>
</div>

<div class="grid">

  <!-- Row 0 -->
  <div class="cell"><img id="arrow_0_0" src="images/256_arrow_red_90.png" style="transform: rotate(180deg);"></div>
  <div class="cell"><img id="arrow_0_1" src="images/256_arrow_red_90.png" style="transform: rotate(180deg);"></div>
  <div class="cell"><img id="arrow_0_2" src="images/256_arrow_red.png" style="transform: rotate(180deg);"></div>
  <div class="cell"><img src="images/256_heater.png"></div>
  <div class="cell"><img id="arrow_0_4" src="images/256_arrow_blue.png" style="transform: rotate(180deg);"></div>
  <div class="cell"><img id="arrow_0_5" src="images/256_arrow_blue_90.png"></div>

  <!-- Row 1 -->
  <div class="cell"><img id="reservoir_img" src="images/256_reservoir.png"></div>
  <div class="cell"><img id="arrow_1_1" src="images/256_arrow_red.png" style="transform: rotate(90deg);"></div>
  <div class="cell">
    <div class="label">HOT</div>
    <div class="value temp-value" id="water_hot">--</div>
  </div>
  <div class="cell">
    <div class="label">delta HEATER</div>
    <div class="value delta-value" id="delta_water_heater">--</div>
  </div>
  <div class="cell">
    <div class="label">COLD</div>
    <div class="value temp-value" id="water_cold">--</div>
  </div>
  <div class="cell"><img id="arrow_1_5" src="images/256_arrow_blue.png" style="transform: rotate(-90deg);"></div>

  <!-- Row 2 -->
  <div class="cell">
    <div class="label">RESERVOIR</div>
    <div class="value temp-value" id="water_reservoir">--</div>
  </div>
  <div class="cell"><img id="arrow_2_1" src="images/256_arrow_red.png" style="transform: rotate(90deg);"></div>
  <div class="cell">
    <div class="label">MIX</div>
    <div class="value temp-value" id="water_mix">--</div>
  </div>
  <div class="cell">
    <div class="label">delta RADIATOR</div>
    <div class="value delta-value" id="delta_water_radiator">--</div>
  </div>
  <div class="cell">
    <div class="label">FLOW</div>
    <div class="value flow-value" id="flow_rate">--</div>
  </div>
  <div class="cell"><img src="images/256_pump.png"></div>

  <!-- Row 3 -->
  <div class="cell"><img id="arrow_3_0" src="images/256_arrow_red_90.png" style="transform: rotate(90deg);"></div>
  <div class="cell"><img id="arrow_3_1" src="images/256_arrow_red_90.png" style="transform: rotate(90deg);"></div>
  <div class="cell"><img id="arrow_3_2" src="images/256_arrow_red.png"></div>
  <div class="cell"><img src="images/256_radiator.png"></div>
  <div class="cell"><img id="arrow_3_4" src="images/256_arrow_blue.png"></div>
  <div class="cell"><img id="arrow_3_5" src="images/256_arrow_blue_90.png" style="transform: rotate(90deg);"></div>

  <!-- Row 4 -->
  <div class="cell"></div>
  <div class="cell">
    <div class="label">COLD</div>
    <div class="value temp-value" id="air_cool">--</div>
  </div>
  <div class="cell"><img src="images/256_arrow_blue.png"></div>
  <div class="cell">
    <img src="images/256_fans.png">
    <div class="label" style="font-size:10px; margin-top:5px;">
      <div class="value delta-value" id="delta_air">--</div>
      <div class="value" id="fan_speed_display" style="font-size:11px; color:#ff8844;">--</div>
    </div>
  </div>
  <div class="cell"><img src="images/256_arrow_red.png"></div>
  <div class="cell">
    <div class="label">WARM</div>
    <div class="value temp-value" id="air_heated">--</div>
  </div>

</div>

</div>

<script>
// WebSocket connection
let ws = null;
let reconnectInterval = null;

// Control mode state
let currentMode = 'manual';

// Ignore windows for manual mode (timestamps when to stop ignoring)
const ignoreWindows = {
  main_loop: 0,
  diversion: 0,
  fan_speed: 0
};

// Track expected states after commands to reject stale broadcasts
const expectedStates = {
  main_loop: null,
  diversion: null,
  fan_speed: null
};

function connectWebSocket() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${window.location.host}/ws`;
  
  ws = new WebSocket(wsUrl);
  
  ws.onopen = () => {
    console.log('WebSocket connected');
    document.getElementById('wsStatus').className = 'status-indicator status-connected';
    if (reconnectInterval) {
      clearInterval(reconnectInterval);
      reconnectInterval = null;
    }
  };
  
  ws.onclose = () => {
    console.log('WebSocket disconnected');
    document.getElementById('wsStatus').className = 'status-indicator status-disconnected';
    
    // Attempt to reconnect every 2 seconds
    if (!reconnectInterval) {
      reconnectInterval = setInterval(connectWebSocket, 2000);
    }
  };
  
  ws.onerror = (error) => {
    console.error('WebSocket error:', error);
  };
  
  ws.onmessage = (event) => {
    console.log('WebSocket message received:', event.data.substring(0, 100) + '...');
    try {
      const data = JSON.parse(event.data);
      console.log('Parsed data:', data);
      updateDisplay(data);
    } catch (e) {
      console.error('Error parsing message:', e);
    }
  };
}

// Helper function to determine arrow color based on temperature
function getArrowColor(temperature) {
  if (temperature === null || temperature === undefined) {
    return 'blue'; // Default to blue if no temp available
  }
  
  if (temperature > 120) {
    return 'red';
  } else if (temperature >= 70) {
    return 'orange';
  } else {
    return 'blue';
  }
}

// Get CSS color for temperature display text (matches arrow colors)
function getTemperatureColor(temperature) {
  if (temperature === null || temperature === undefined) {
    return '#3399FF'; // Blue - default
  }
  
  if (temperature > 120) {
    return '#FF3333'; // Red - hot
  } else if (temperature >= 70) {
    return '#FF8800'; // Orange - warm
  } else {
    return '#3399FF'; // Blue - cold
  }
}

// Update reservoir image based on temperature
function updateReservoirImage(temperature) {
  const reservoirImg = document.getElementById('reservoir_img');
  if (!reservoirImg) return;
  
  if (temperature === null || temperature === undefined) {
    reservoirImg.src = 'images/256_reservoir.png'; // Default blue
  } else if (temperature > 120) {
    reservoirImg.src = 'images/256_reservoir_hot.png'; // Red/hot
  } else if (temperature >= 70) {
    reservoirImg.src = 'images/256_reservoir_warm.png'; // Orange/warm
  } else {
    reservoirImg.src = 'images/256_reservoir.png'; // Blue/cold
  }
}

// Update arrow colors for STATIC arrows only (never change type/rotation)
// Dynamic arrows (0:0, 0:1, 1:0, 1:1, 2:1, 3:0, 3:1) are handled entirely by updateArrowVisibility()
function updateArrowColors(data) {
  const temps = data.temperatures;
  if (!temps) return;
  
  // Get colors for each temperature zone
  const hotColor = getArrowColor(temps.water_hot);
  const mixColor = getArrowColor(temps.water_mix);
  const coldColor = getArrowColor(temps.water_cold);
  
  // Water_hot: ONLY arrow 0:2 (always straight, always rotate(180deg))
  updateArrowColorOnly('arrow_0_2', hotColor, '');
  
  // Water_mix: ONLY arrow 3:2 (always straight, always no rotation)
  updateArrowColorOnly('arrow_3_2', mixColor, '');
  
  // Water_cold arrows - all static
  updateArrowColorOnly('arrow_0_4', coldColor, '');
  updateArrowColorOnly('arrow_0_5', coldColor, '_90');
  updateArrowColorOnly('arrow_1_5', coldColor, '');
  updateArrowColorOnly('arrow_3_4', coldColor, '');
  updateArrowColorOnly('arrow_3_5', coldColor, '_90');
  
  console.log(`Arrow colors updated: hot=${hotColor}, mix=${mixColor}, cold=${coldColor}`);
}

// Helper to update ONLY the arrow color, preserving rotation
function updateArrowColorOnly(elementId, color, suffix) {
  const element = document.getElementById(elementId);
  if (element) {
    element.src = `images/256_arrow_${color}${suffix}.png`;
    // Do NOT touch transform - that's handled by updateArrowVisibility()
  }
}

// Helper to update an arrow image source AND rotation
function updateArrowImage(elementId, color, suffix, transform) {
  const element = document.getElementById(elementId);
  if (element) {
    element.src = `images/256_arrow_${color}${suffix}.png`;
    if (transform !== undefined) {
      element.style.transform = transform;
    }
  }
}

// Update arrow visibility and direction based on flow mode
function updateArrowVisibility(flowMode, temps) {
  if (!flowMode || !temps) return;
  
  const hotColor = getArrowColor(temps.water_hot);
  const mixColor = getArrowColor(temps.water_mix);
  const reservoirColor = getArrowColor(temps.water_reservoir);
  
  console.log(`Updating arrow visibility for flow mode: ${flowMode}`);
  
  // Get all arrow cells
  const arrow_0_0 = document.getElementById('arrow_0_0');
  const arrow_0_1 = document.getElementById('arrow_0_1');
  const arrow_1_1 = document.getElementById('arrow_1_1');
  const arrow_2_1 = document.getElementById('arrow_2_1');
  const arrow_3_0 = document.getElementById('arrow_3_0');
  const arrow_3_1 = document.getElementById('arrow_3_1');
  
  if (flowMode === 'main') {
    // Main mode: main ON, diversion OFF
    // Hide: 0:0, 3:0 (hide the image only, not the cell)
    if (arrow_0_0) arrow_0_0.style.visibility = 'hidden';
    if (arrow_3_0) arrow_3_0.style.visibility = 'hidden';
    
    // Show and configure visible arrows
    if (arrow_0_1) {
      arrow_0_1.style.visibility = 'visible';
      updateArrowImage('arrow_0_1', hotColor, '_90', 'rotate(270deg)'); // 270Â° (was 90Â° + 180Â°)
    }
    if (arrow_1_1) {
      arrow_1_1.style.visibility = 'visible';
      updateArrowImage('arrow_1_1', hotColor, '', 'rotate(90deg)'); // Down arrow
    }
    if (arrow_2_1) {
      arrow_2_1.style.visibility = 'visible';
      updateArrowImage('arrow_2_1', hotColor, '', 'rotate(90deg)'); // Down arrow
    }
    if (arrow_3_1) {
      arrow_3_1.style.visibility = 'visible';
      updateArrowImage('arrow_3_1', mixColor, '_90', 'rotate(180deg)'); // 180Â° (was 90Â° + 90Â°)
    }
    
  } else if (flowMode === 'diversion') {
    // Diversion mode: main OFF, diversion ON
    // Hide: 1:1, 2:1 (hide the image only, not the cell)
    if (arrow_1_1) arrow_1_1.style.visibility = 'hidden';
    if (arrow_2_1) arrow_2_1.style.visibility = 'hidden';
    
    // Show and configure others with special directions
    if (arrow_0_1) {
      arrow_0_1.style.visibility = 'visible';
      updateArrowImage('arrow_0_1', hotColor, '', 'rotate(180deg)'); // 180Â° rotation (no change)
    }
    if (arrow_3_0) {
      arrow_3_0.style.visibility = 'visible';
      updateArrowImage('arrow_3_0', mixColor, '_90', 'rotate(180deg)'); // 180Â° (was 90Â° + 90Â°)
    }
    if (arrow_3_1) {
      arrow_3_1.style.visibility = 'visible';
      updateArrowImage('arrow_3_1', mixColor, '', 'rotate(0deg)'); // 0Â° (was -90Â° + 90Â°)
    }
    if (arrow_0_0) {
      arrow_0_0.style.visibility = 'visible';
      updateArrowImage('arrow_0_0', hotColor, '_90', 'rotate(270deg)'); // 270Â° (was 180Â° + 90Â°)
    }
    
  } else if (flowMode === 'mix') {
    // Mix mode: main ON, diversion ON
    // Show all arrows, with branching arrows at 0:1 and 3:1
    if (arrow_0_0) {
      arrow_0_0.style.visibility = 'visible';
      updateArrowImage('arrow_0_0', hotColor, '_90', 'rotate(270deg)'); // 270Â° (was 180Â° + 90Â°)
    }
    if (arrow_0_1) {
      arrow_0_1.style.visibility = 'visible';
      updateArrowImage('arrow_0_1', hotColor, '_branch', 'rotate(0deg)'); // 0Â° or 360Â° (was 180Â° + 180Â°)
    }
    if (arrow_1_1) {
      arrow_1_1.style.visibility = 'visible';
      updateArrowImage('arrow_1_1', hotColor, '', 'rotate(90deg)'); // DOWN arrow (no change)
    }
    if (arrow_2_1) {
      arrow_2_1.style.visibility = 'visible';
      updateArrowImage('arrow_2_1', hotColor, '', 'rotate(90deg)'); // DOWN arrow (no change)
    }
    if (arrow_3_0) {
      arrow_3_0.style.visibility = 'visible';
      updateArrowImage('arrow_3_0', reservoirColor, '_90', 'rotate(90deg)'); // 90Â° (CCW from previous 180Â°)
    }
    if (arrow_3_1) {
      arrow_3_1.style.visibility = 'visible';
      updateArrowImage('arrow_3_1', mixColor, '_branch', 'rotate(180deg)'); // 180Â° (was 90Â° + 90Â°)
    }
    
  } else {
    // 'none' or unknown mode - show all arrows with default colors
    console.warn(`Unknown flow mode: ${flowMode}, showing all arrows with default colors`);
    if (arrow_0_0) arrow_0_0.style.visibility = 'visible';
    if (arrow_0_1) arrow_0_1.style.visibility = 'visible';
    if (arrow_1_1) arrow_1_1.style.visibility = 'visible';
    if (arrow_2_1) arrow_2_1.style.visibility = 'visible';
    if (arrow_3_0) arrow_3_0.style.visibility = 'visible';
    if (arrow_3_1) arrow_3_1.style.visibility = 'visible';
  }
}

function updateDisplay(data) {
  console.log('updateDisplay called with:', data);
  
  // Update mode if changed
  if (data.control_mode && data.control_mode !== currentMode) {
    switchMode(data.control_mode);
  }
  
  // Update temperatures (always update sensor displays) with dynamic colors
  const temps = data.temperatures;
  updateTemperatureValue('water_hot', temps.water_hot, 'Â°');
  updateTemperatureValue('water_reservoir', temps.water_reservoir, 'Â°');
  updateTemperatureValue('water_mix', temps.water_mix, 'Â°');
  updateTemperatureValue('water_cold', temps.water_cold, 'Â°');
  updateTemperatureValue('air_cool', temps.air_cool, 'Â°');
  updateTemperatureValue('air_heated', temps.air_heated, 'Â°');
  
  // Update reservoir image based on temperature
  updateReservoirImage(temps.water_reservoir);
  
  // Update arrow visibility and direction based on flow mode FIRST
  // (This sets type, color, and rotation for dynamic arrows)
  if (data.flow_mode) {
    updateArrowVisibility(data.flow_mode, temps);
  }
  
  // Then update colors for static arrows
  // (This only updates colors, not types or rotations)
  updateArrowColors(data);
  
  // Update deltas
  const deltas = data.deltas;
  updateValue('delta_water_heater', deltas.delta_water_heater, 'Â°');
  updateValue('delta_water_radiator', deltas.delta_water_radiator, 'Â°');
  updateValue('delta_air', deltas.delta_air, 'Â°');
  
  // Update flow rate
  updateValue('flow_rate', data.flow_rate, '');
  
  // Update fan speed display
  updateValue('fan_speed_display', data.fan_speed, '%');
  
  // Update control states based on mode
  const mainLoopToggle = document.getElementById('mainLoopToggle');
  const diversionToggle = document.getElementById('diversionToggle');
  const fanSpeedInput = document.getElementById('fanSpeedInput');
  const fanSpeedSlider = document.getElementById('fanSpeedSlider');
  
  // Main loop toggle - only block updates that would CHANGE the current state
  const inIgnoreWindowMain = Date.now() < ignoreWindows.main_loop;
  const wouldChangeMain = (mainLoopToggle.checked !== data.main_loop_state);
  if (!inIgnoreWindowMain || !wouldChangeMain) {
    // Accept if: outside ignore window OR update matches current state
    if (mainLoopToggle.checked !== data.main_loop_state) {
      mainLoopToggle.checked = data.main_loop_state;
      document.getElementById('mainLoopLabel').textContent = data.main_loop_state ? 'ON' : 'OFF';
      console.log(`Accepted main_loop update: ${data.main_loop_state}`);
    }
  } else {
    console.log(`Blocked main_loop change from ${mainLoopToggle.checked} to ${data.main_loop_state}`);
  }
  
  // Diversion toggle - only block updates that would CHANGE the current state
  const inIgnoreWindowDiv = Date.now() < ignoreWindows.diversion;
  const wouldChangeDiv = (diversionToggle.checked !== data.diversion_state);
  if (!inIgnoreWindowDiv || !wouldChangeDiv) {
    // Accept if: outside ignore window OR update matches current state
    if (diversionToggle.checked !== data.diversion_state) {
      diversionToggle.checked = data.diversion_state;
      document.getElementById('diversionLabel').textContent = data.diversion_state ? 'ON' : 'OFF';
      console.log(`Accepted diversion update: ${data.diversion_state}`);
    }
  } else {
    console.log(`Blocked diversion change from ${diversionToggle.checked} to ${data.diversion_state}`);
  }
  
  // Fan controls - update if not ignoring and not focused
  if (!shouldIgnoreUpdate('fan_speed', data.fan_speed)) {
    if (document.activeElement !== fanSpeedInput && document.activeElement !== fanSpeedSlider) {
      fanSpeedInput.value = data.fan_speed;
      fanSpeedSlider.value = data.fan_speed;
    }
  }
  
  // Update Save toggle state
  if (data.save_enabled !== undefined) {
    const saveToggle = document.getElementById('saveToggle');
    if (saveToggle.checked !== data.save_enabled) {
      saveToggle.checked = data.save_enabled;
      document.getElementById('saveLabel').textContent = data.save_enabled ? 'ON' : 'OFF';
    }
  }
  
  // Update Graph toggle state
  if (data.graph_enabled !== undefined) {
    const graphToggle = document.getElementById('graphToggle');
    if (graphToggle.checked !== data.graph_enabled) {
      graphToggle.checked = data.graph_enabled;
      document.getElementById('graphLabel').textContent = data.graph_enabled ? 'ON' : 'OFF';
    }
  }
}

// Update temperature value with dynamic color based on temperature
function updateTemperatureValue(elementId, value, unit = '') {
  const element = document.getElementById(elementId);
  if (element) {
    if (value !== null && value !== undefined) {
      element.textContent = value + unit;
      // Apply dynamic color based on temperature thresholds
      element.style.color = getTemperatureColor(value);
    } else {
      element.textContent = '--';
      element.style.color = '#888'; // Gray for no data
    }
  }
}

function updateValue(elementId, value, unit = '') {
  const element = document.getElementById(elementId);
  if (element) {
    if (value !== null && value !== undefined) {
      element.textContent = value + unit;
      console.log(`Updated ${elementId}: ${value}${unit}`);
    } else {
      element.textContent = '--';
      console.log(`Updated ${elementId}: -- (null/undefined)`);
    }
  } else {
    console.error(`Element not found: ${elementId}`);
  }
}

function shouldIgnoreUpdate(controlName, incomingValue = null) {
  // In automatic mode, never ignore updates
  if (currentMode === 'automatic') return false;
  
  // In manual mode, check if we're within the ignore window
  if (Date.now() < ignoreWindows[controlName]) {
    // NUCLEAR OPTION: Block ALL updates during ignore window
    console.log(`Blocking ${controlName} update: ${incomingValue} (ignore window active)`);
    return true; // Ignore everything
  }
  
  // Outside ignore window - clear expected state and accept all updates
  expectedStates[controlName] = null;
  return false;
}

function setIgnoreWindow(controlName, durationMs = 1000) {
  ignoreWindows[controlName] = Date.now() + durationMs;
  console.log(`Set ignore window for ${controlName} for ${durationMs}ms`);
}

function setExpectedState(controlName, value) {
  expectedStates[controlName] = value;
  console.log(`Set expected state for ${controlName}: ${value}`);
}

function switchMode(mode) {
  currentMode = mode;
  console.log(`Switched to ${mode} mode`);
  
  const modeSelector = document.getElementById('modeSelector');
  const modeBadge = document.getElementById('modeBadge');
  const modeToggle = document.getElementById('modeToggle');
  const controlsPanel = document.getElementById('controlsPanel');
  const automationNotice = document.getElementById('automationNotice');
  
  // Update toggle state without triggering event
  modeToggle.checked = (mode === 'automatic');
  
  if (mode === 'automatic') {
    // Automatic mode
    modeSelector.className = 'mode-selector automatic';
    modeBadge.className = 'mode-badge automatic';
    modeBadge.textContent = 'AUTOMATIC';
    
    // Disable controls
    document.getElementById('mainLoopToggle').disabled = true;
    document.getElementById('diversionToggle').disabled = true;
    document.getElementById('fanSpeedInput').disabled = true;
    document.getElementById('fanSpeedSlider').disabled = true;
    
    // Show automation notice
    automationNotice.className = 'automation-notice visible';
    
    // Clear all ignore windows
    ignoreWindows.main_loop = 0;
    ignoreWindows.diversion = 0;
    ignoreWindows.fan_speed = 0;
  } else {
    // Manual mode
    modeSelector.className = 'mode-selector manual';
    modeBadge.className = 'mode-badge manual';
    modeBadge.textContent = 'MANUAL';
    
    // Enable controls
    document.getElementById('mainLoopToggle').disabled = false;
    document.getElementById('diversionToggle').disabled = false;
    document.getElementById('fanSpeedInput').disabled = false;
    document.getElementById('fanSpeedSlider').disabled = false;
    
    // Hide automation notice
    automationNotice.className = 'automation-notice';
  }
}

function sendCommand(command) {
  console.log('Sending command:', command);
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(command));
    console.log('Command sent successfully');
  } else {
    console.error('WebSocket not open. State:', ws ? ws.readyState : 'null');
  }
}

// Connect on page load
connectWebSocket();
</script>

</body>
</html>
