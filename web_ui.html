<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shop Heater Web UI</title>

<style>
  body {
    margin: 0;
    background: #111;
    color: #ddd;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    padding: 20px;
  }

  .container {
    width: 100%;
    max-width: 900px;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    width: 100%;
    margin-bottom: 30px;
  }

  .cell {
    aspect-ratio: 1 / 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  img {
    width: 64%;
    height: auto;
    display: block;
    transform-origin: center center;
  }

  .label {
    font-size: 12px;
    color: #aaa;
    text-align: center;
  }

  .value {
    font-size: 14px;
    font-weight: bold;
    color: #fff;
    text-align: center;
  }

  .temp-value {
    color: #ff8844;
  }

  .delta-value {
    color: #44ff88;
  }

  .flow-value {
    color: #4488ff;
  }

  .overlay-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 16px;
    font-weight: bold;
    color: #fff;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    z-index: 10;
  }

  .controls {
    background: #222;
    padding: 20px;
    border-radius: 8px;
    width: 100%;
  }

  .control-group {
    margin-bottom: 20px;
  }

  .control-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #fff;
  }

  .toggle-container {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .toggle {
    position: relative;
    width: 60px;
    height: 30px;
  }

  .toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #555;
    transition: .4s;
    border-radius: 30px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: #4CAF50;
  }

  input:checked + .slider:before {
    transform: translateX(30px);
  }

  .toggle-label {
    font-size: 14px;
    color: #aaa;
  }

  .fan-controls {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  .fan-controls input[type="number"] {
    width: 80px;
    padding: 8px;
    font-size: 16px;
    background: #333;
    color: #fff;
    border: 1px solid #555;
    border-radius: 4px;
  }

  .fan-controls input[type="range"] {
    flex: 1;
    height: 8px;
    background: #555;
    border-radius: 5px;
    outline: none;
  }

  .fan-controls input[type="range"]::-webkit-slider-thumb {
    width: 20px;
    height: 20px;
    background: #4CAF50;
    cursor: pointer;
    border-radius: 50%;
  }

  .status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-left: 10px;
  }

  .status-connected {
    background: #4CAF50;
  }

  .status-disconnected {
    background: #f44336;
  }

  h2 {
    color: #fff;
    margin-top: 0;
    display: flex;
    align-items: center;
  }
</style>
</head>

<body>

<div class="container">

<h2>Shop Heater Control <span class="status-indicator" id="wsStatus"></span></h2>

<div class="grid">

  <!-- Row 0 -->
  <div class="cell"><img src="images/256_arrow_red_90.png" style="transform: rotate(180deg);"></div>
  <div class="cell"><img src="images/256_arrow_red_90.png" style="transform: rotate(180deg);"></div>
  <div class="cell"><img src="images/256_arrow_red.png" style="transform: rotate(180deg);"></div>
  <div class="cell"><img src="images/256_heater.png"></div>
  <div class="cell"><img src="images/256_arrow_blue.png" style="transform: rotate(180deg);"></div>
  <div class="cell"><img src="images/256_arrow_blue_90.png"></div>

  <!-- Row 1 -->
  <div class="cell"><img src="images/256_arrow_red.png" style="transform: rotate(90deg);"></div>
  <div class="cell"><img src="images/256_arrow_red.png" style="transform: rotate(90deg);"></div>
  <div class="cell">
    <div class="label">HOT</div>
    <div class="value temp-value" id="water_hot">--</div>
  </div>
  <div class="cell">
    <div class="label">delta HEATER</div>
    <div class="value delta-value" id="delta_water_heater">--</div>
  </div>
  <div class="cell">
    <div class="label">COLD</div>
    <div class="value temp-value" id="water_cold">--</div>
  </div>
  <div class="cell"><img src="images/256_arrow_blue.png" style="transform: rotate(-90deg);"></div>

  <!-- Row 2 -->
  <div class="cell">
    <img src="images/256_reservoir.png">
    <div class="overlay-value temp-value" id="water_reservoir">--</div>
  </div>
  <div class="cell"><img src="images/256_arrow_red.png" style="transform: rotate(90deg);"></div>
  <div class="cell">
    <div class="label">MIX</div>
    <div class="value temp-value" id="water_mix">--</div>
  </div>
  <div class="cell">
    <div class="label">delta RADIATOR</div>
    <div class="value delta-value" id="delta_water_radiator">--</div>
  </div>
  <div class="cell">
    <div class="label">FLOW</div>
    <div class="value flow-value" id="flow_rate">--</div>
  </div>
  <div class="cell"><img src="images/256_pump.png"></div>

  <!-- Row 3 -->
  <div class="cell"><img src="images/256_arrow_red_90.png" style="transform: rotate(90deg);"></div>
  <div class="cell"><img src="images/256_arrow_red_90.png" style="transform: rotate(90deg);"></div>
  <div class="cell"><img src="images/256_arrow_red.png"></div>
  <div class="cell"><img src="images/256_radiator.png"></div>
  <div class="cell"><img src="images/256_arrow_blue.png"></div>
  <div class="cell"><img src="images/256_arrow_blue_90.png" style="transform: rotate(90deg);"></div>

  <!-- Row 4 -->
  <div class="cell"></div>
  <div class="cell">
    <div class="label">COLD</div>
    <div class="value temp-value" id="air_cool">--</div>
  </div>
  <div class="cell"><img src="images/256_arrow_blue.png"></div>
  <div class="cell">
    <img src="images/256_fans.png">
    <div class="label" style="font-size:10px; margin-top:5px;">
      <div class="value delta-value" id="delta_air">--</div>
      <div class="value" id="fan_speed_display" style="font-size:11px; color:#ff8844;">--</div>
    </div>
  </div>
  <div class="cell"><img src="images/256_arrow_red.png"></div>
  <div class="cell">
    <div class="label">WARM</div>
    <div class="value temp-value" id="air_heated">--</div>
  </div>

</div>

<!-- Control Panel -->
<div class="controls">
  <h3 style="margin-top:0; color:#fff;">Controls</h3>
  
  <div class="control-group">
    <label>Main Loop Solenoid</label>
    <div class="toggle-container">
      <label class="toggle">
        <input type="checkbox" id="mainLoopToggle">
        <span class="slider"></span>
      </label>
      <span class="toggle-label" id="mainLoopLabel">OFF</span>
    </div>
  </div>
  
  <div class="control-group">
    <label>Diversion Solenoid</label>
    <div class="toggle-container">
      <label class="toggle">
        <input type="checkbox" id="diversionToggle">
        <span class="slider"></span>
      </label>
      <span class="toggle-label" id="diversionLabel">OFF</span>
    </div>
  </div>
  
  <div class="control-group">
    <label>Fan Speed (0-100)</label>
    <div class="fan-controls">
      <input type="number" id="fanSpeedInput" min="0" max="100" value="0">
      <input type="range" id="fanSpeedSlider" min="0" max="100" value="0">
    </div>
  </div>
</div>

</div>

<script>
// WebSocket connection
let ws = null;
let reconnectInterval = null;

function connectWebSocket() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${window.location.host}/ws`;
  
  ws = new WebSocket(wsUrl);
  
  ws.onopen = () => {
    console.log('WebSocket connected');
    document.getElementById('wsStatus').className = 'status-indicator status-connected';
    if (reconnectInterval) {
      clearInterval(reconnectInterval);
      reconnectInterval = null;
    }
  };
  
  ws.onclose = () => {
    console.log('WebSocket disconnected');
    document.getElementById('wsStatus').className = 'status-indicator status-disconnected';
    
    // Attempt to reconnect every 2 seconds
    if (!reconnectInterval) {
      reconnectInterval = setInterval(connectWebSocket, 2000);
    }
  };
  
  ws.onerror = (error) => {
    console.error('WebSocket error:', error);
  };
  
  ws.onmessage = (event) => {
    console.log('WebSocket message received:', event.data.substring(0, 100) + '...');
    try {
      const data = JSON.parse(event.data);
      console.log('Parsed data:', data);
      updateDisplay(data);
    } catch (e) {
      console.error('Error parsing message:', e);
    }
  };
}

function updateDisplay(data) {
  console.log('updateDisplay called with:', data);
  // Update temperatures
  const temps = data.temperatures;
  updateValue('water_hot', temps.water_hot, '°F');
  updateValue('water_reservoir', temps.water_reservoir, '°F');
  updateValue('water_mix', temps.water_mix, '°F');
  updateValue('water_cold', temps.water_cold, '°F');
  updateValue('air_cool', temps.air_cool, '°F');
  updateValue('air_heated', temps.air_heated, '°F');
  
  // Update deltas
  const deltas = data.deltas;
  updateValue('delta_water_heater', deltas.delta_water_heater, '°F');
  updateValue('delta_water_radiator', deltas.delta_water_radiator, '°F');
  updateValue('delta_air', deltas.delta_air, '°F');
  
  // Update flow rate
  updateValue('flow_rate', data.flow_rate, ' L/min');
  
  // Update fan speed display
  updateValue('fan_speed_display', data.fan_speed, '%');
  
  // Update control states (without triggering change events)
  const mainLoopToggle = document.getElementById('mainLoopToggle');
  const diversionToggle = document.getElementById('diversionToggle');
  const fanSpeedInput = document.getElementById('fanSpeedInput');
  const fanSpeedSlider = document.getElementById('fanSpeedSlider');
  
  if (mainLoopToggle.checked !== data.main_loop_state) {
    mainLoopToggle.checked = data.main_loop_state;
    document.getElementById('mainLoopLabel').textContent = data.main_loop_state ? 'ON' : 'OFF';
  }
  
  if (diversionToggle.checked !== data.diversion_state) {
    diversionToggle.checked = data.diversion_state;
    document.getElementById('diversionLabel').textContent = data.diversion_state ? 'ON' : 'OFF';
  }
  
  // Only update fan controls if they don't have focus (user isn't actively changing them)
  if (document.activeElement !== fanSpeedInput && document.activeElement !== fanSpeedSlider) {
    fanSpeedInput.value = data.fan_speed;
    fanSpeedSlider.value = data.fan_speed;
  }
}

function updateValue(elementId, value, unit = '') {
  const element = document.getElementById(elementId);
  if (element) {
    if (value !== null && value !== undefined) {
      element.textContent = value + unit;
    } else {
      element.textContent = '--';
    }
  }
}

function sendCommand(command) {
  console.log('Sending command:', command);
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(command));
    console.log('Command sent successfully');
  } else {
    console.error('WebSocket not open. State:', ws ? ws.readyState : 'null');
  }
}

// Control event listeners
document.getElementById('mainLoopToggle').addEventListener('change', (e) => {
  const state = e.target.checked;
  document.getElementById('mainLoopLabel').textContent = state ? 'ON' : 'OFF';
  sendCommand({ main_loop: state });
});

document.getElementById('diversionToggle').addEventListener('change', (e) => {
  const state = e.target.checked;
  document.getElementById('diversionLabel').textContent = state ? 'ON' : 'OFF';
  sendCommand({ diversion: state });
});

// Synchronize fan speed input and slider
document.getElementById('fanSpeedInput').addEventListener('input', (e) => {
  const value = parseInt(e.target.value) || 0;
  const clamped = Math.max(0, Math.min(100, value));
  document.getElementById('fanSpeedSlider').value = clamped;
  sendCommand({ fan_speed: clamped });
});

document.getElementById('fanSpeedSlider').addEventListener('input', (e) => {
  const value = parseInt(e.target.value);
  document.getElementById('fanSpeedInput').value = value;
  sendCommand({ fan_speed: value });
});

// Connect on page load
connectWebSocket();
</script>

</body>
</html>
